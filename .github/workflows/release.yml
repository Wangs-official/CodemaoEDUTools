name: Release & Publish PyPI

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # Checkout
      # ======================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ======================
      # Read version from pyproject.toml
      # ======================
      - name: Read version
        id: version
        run: |
          python - << 'EOF' >> "$GITHUB_OUTPUT"
          import re
          from pathlib import Path

          path = Path("pyproject.toml")
          if not path.exists():
              raise SystemExit("âŒ pyproject.toml not found")

          text = path.read_text(encoding="utf-8")
          m = re.search(r'version = "(.*?)"', text)
          if not m:
              raise SystemExit("âŒ version not found")

          print(f"version={m.group(1)}")
          EOF

      # ======================
      # Ensure tag does not exist
      # ======================
      - name: Check tag not exist
        run: |
          if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "âŒ Tag ${{ steps.version.outputs.version }} already exists"
            exit 1
          fi

      # ======================
      # Create & push tag
      # ======================
      - name: Create and push tag
        run: |
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}

      # ======================
      # Get merged PR body (preserve Markdown)
      # ======================
      - name: Get PR description
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "closed",
              base: "main",
              per_page: 5
            });

            const pr = prs.find(p => p.merge_commit_sha === context.sha);
            const body = pr && pr.body ? pr.body : "";

            fs.appendFileSync(
              process.env.GITHUB_OUTPUT,
              `body<<EOF\n${body}\nEOF\n`
            );

      # ======================
      # Set up Python
      # ======================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ======================
      # Install build dependencies (critical: packaging >= 23.1)
      # ======================
      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv venv
          uv sync
          uv add "packaging>=23.1" build twine

      # ======================
      # Build release archives
      # ======================
      - name: Build zip and tar.gz
        run: |
          mkdir release
          rsync -av \
            --exclude .git \
            --exclude .github \
            --exclude doc \
            --exclude .gitignore \
            --exclude README.md \
            --exclude main.py \
            --exclude setup.py \
            CodemaoEDUTools release/CodemaoEDUTools

          cd release
          zip -r ../cet-${{ steps.version.outputs.version }}.zip CodemaoEDUTools
          tar czf ../cet-${{ steps.version.outputs.version }}.tar.gz CodemaoEDUTools

      # ======================
      # Build Python package
      # ======================
      - name: Build Python package
        run: |
          rm -rf build dist *.egg-info
          uv run python -m build

      # ======================
      # Create GitHub Release
      # ======================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Version ${{ steps.version.outputs.version }}
          body: |
            <img src="https://s3.bmp.ovh/imgs/2024/10/25/7cd326afa68c3c6a.png" width="81" alt="è¨€å¶å¤§é­”ç‹">

            ## ğŸ”§ å‘è¡Œç‰ˆè¯´æ˜ï¼š

            æ­¤å‘è¡Œç‰ˆç”± GitHub Action è‡ªåŠ¨ç”Ÿæˆã€‚å¦‚æœä½ è¦å°† CodemaoEDUTools ä½œä¸ºåº“å¯¼å…¥åˆ°é¡¹ç›®ä¸­ï¼Œè¯·ä¸‹è½½æ­¤å‘è¡Œç‰ˆã€‚

            ## ğŸ± ä¸åŒä¹‹å¤„ï¼š

            æ­¤å‘è¡Œç‰ˆä»…åŒ…å« **CodemaoEDUTools** åº“æ–‡ä»¶å¤¹ï¼Œå¹¶é¢å¤–æä¾›å¯ç›´æ¥å®‰è£…çš„ wheel åŒ…ã€‚

            ## ğŸ”§ ä½¿ç”¨æ–¹æ³•ï¼š

            - ç›´æ¥æ‹·è´ **CodemaoEDUTools** æ–‡ä»¶å¤¹åˆ°ä½ çš„é¡¹ç›®
            - æˆ–ä¸‹è½½ wheel åŒ…è¿›è¡Œæœ¬åœ°å®‰è£…

            å¯¼å…¥ï¼š`import CodemaoEDUTools`  
            å®‰è£…ï¼š`pip install <wheelåŒ…è·¯å¾„>` æˆ– `pip install CodemaoEDUTools`

            ## ğŸ’» æ›´æ–°æ—¥å¿—

            ${{ steps.pr.outputs.body }}
          files: |
            cet-${{ steps.version.outputs.version }}.zip
            cet-${{ steps.version.outputs.version }}.tar.gz
            dist/*.whl

      # ======================
      # Publish to PyPI
      # ======================
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -d dist ]; then
            python -m twine upload dist/*
          else
            echo "âš ï¸ No dist directory, skip PyPI"
          fi
