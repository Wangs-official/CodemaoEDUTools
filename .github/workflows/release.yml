name: Release & Publish PyPI

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # Checkout
      # ======================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ======================
      # Read version from CodemaoEDUTools/__init__.py
      # ======================
      - name: Read version
        id: version
        run: |
          python - << 'EOF' >> "$GITHUB_OUTPUT"
          import re
          from pathlib import Path

          path = Path("CodemaoEDUTools/__init__.py")
          if not path.exists():
              raise SystemExit("âŒ CodemaoEDUTools/__init__.py not found")

          text = path.read_text(encoding="utf-8")
          m = re.search(r'__version__\s*=\s*"([^"]+)"', text)
          if not m:
              raise SystemExit("âŒ __version__ not found")

          print(f"version={m.group(1)}")
          EOF

      # ======================
      # Ensure tag does not exist
      # ======================
      - name: Check tag not exists
        run: |
          if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "âŒ Tag ${{ steps.version.outputs.version }} already exists"
            exit 1
          fi

      # ======================
      # Create & push tag
      # ======================
      - name: Create and push tag
        run: |
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}

      # ======================
      # Get merged PR body via GitHub API
      # ======================
      - name: Get PR description
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "closed",
              base: "main",
              per_page: 5
            });

            const pr = prs.find(p => p.merge_commit_sha === context.sha);
            return pr ? (pr.body || "") : "";

      # ======================
      # Build release archives
      # ======================
      - name: Build zip and tar.gz
        run: |
          mkdir release
          rsync -av \
            --exclude .git \
            --exclude .github \
            --exclude doc \
            --exclude .gitignore \
            --exclude README.md \
            --exclude main.py \
            --exclude setup.py \
            CodemaoEDUTools release/CodemaoEDUTools

          cd release
          zip -r ../cet-${{ steps.version.outputs.version }}.zip CodemaoEDUTools
          tar czf ../cet-${{ steps.version.outputs.version }}.tar.gz CodemaoEDUTools

      # ======================
      # Build wheel (optional)
      # ======================
      - name: Build wheel
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip build
          python -m build

      # ======================
      # Create GitHub Release
      # ======================
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Version ${{ steps.version.outputs.version }}
          body: |
            <img src="https://s3.bmp.ovh/imgs/2024/10/25/7cd326afa68c3c6a.png" width="81" alt="è¨€å¶å¤§é­”ç‹">

            ## ğŸ”§ å‘è¡Œç‰ˆè¯´æ˜ï¼š

            æ­¤å‘è¡Œç‰ˆç”±GitHub Actionç”Ÿæˆï¼Œå¦‚æœä½ è¦å°†CodemaoEDUToolsä½œä¸ºåº“å¯¼å…¥åˆ°é¡¹ç›®å†…ï¼Œè¯·ä¸‹è½½æ­¤å‘è¡Œç‰ˆ

            ## ğŸ± ä¸åŒä¹‹å¤„ï¼š

            æ­¤å‘è¡Œç‰ˆä»…åŒ…å«äº† **CodemaoEDUTools** åº“æ–‡ä»¶å¤¹ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†å¯ä»¥ç›´æ¥å®‰è£…çš„ wheel åŒ…

            ## ğŸ”§ ä½¿ç”¨æ–¹æ³•ï¼š

            å°†æ•´ä¸ª **CodemaoEDUTools** åº“æ–‡ä»¶å¤¹æ”¾å…¥åˆ°ä½ çš„é¡¹ç›®å†…ï¼Œæˆ–è€…ä¸‹è½½ wheel åŒ…è¿›è¡Œæœ¬åœ°å®‰è£…

            å¯¼å…¥ï¼š`import CodemaoEDUTools`
            å®‰è£…ï¼š`pip install <wheelåŒ…è·¯å¾„>` æˆ–è€… `pip install CodemaoEDUTools`

            ## ğŸ’» æ›´æ–°æ—¥å¿—

            ${{ steps.pr.outputs.result }}
          files: |
            cet-${{ steps.version.outputs.version }}.zip
            cet-${{ steps.version.outputs.version }}.tar.gz
            dist/*.whl

      # ======================
      # Publish to PyPI
      # ======================
      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -d dist ]; then
            python -m pip install twine
            python -m twine upload dist/*
          else
            echo "âš ï¸ No dist directory, skip PyPI"
          fi
