name: Release on main

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest

    env:
      PACKAGE_DIR: .   # __init__.py 在仓库根目录

    steps:
      # ==============================
      # Checkout
      # ==============================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          tags: true

      # ==============================
      # Read version from __init__.py
      # ==============================
      - name: Read version
        id: version
        run: |
          if [ ! -f "__init__.py" ]; then
            echo "❌ __init__.py not found in repo root"
            exit 1
          fi

          VERSION=$(python - << 'EOF'
          import re
          from pathlib import Path

          content = Path("__init__.py").read_text(encoding="utf-8")
          m = re.search(r"__version__\s*=\s*['\"]([^'\"]+)['\"]", content)
          if not m:
              raise SystemExit("❌ __version__ not found")
          print(m.group(1))
          EOF
          )

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ==============================
      # Get previous tag
      # ==============================
      - name: Get previous tag
        id: prev
        run: |
          git fetch --tags
          PREV_TAG=$(git tag --sort=-creatordate | head -n 1 || true)
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      # ==============================
      # Ensure __version__ updated
      # ==============================
      - name: Ensure version updated
        run: |
          if [ -z "${{ steps.prev.outputs.tag }}" ]; then
            echo "✅ No previous tag, first release"
            exit 0
          fi

          if ! git show ${{ steps.prev.outputs.tag }}:__init__.py > /tmp/old_init.py 2>/dev/null; then
            echo "⚠️ Old __init__.py not found, skip version check"
            exit 0
          fi

          OLD_VERSION=$(python - << 'EOF'
          import re, pathlib

          content = pathlib.Path("/tmp/old_init.py").read_text(encoding="utf-8")
          m = re.search(r"__version__\s*=\s*['\"]([^'\"]+)['\"]", content)
          print(m.group(1) if m else "")
          EOF
          )

          if [ -z "$OLD_VERSION" ]; then
            echo "⚠️ Old version not found, skip version check"
            exit 0
          fi

          if [ "$OLD_VERSION" = "${{ steps.version.outputs.version }}" ]; then
            echo "❌ __version__ not changed ($OLD_VERSION)"
            exit 1
          fi

          echo "✅ Version changed: $OLD_VERSION → ${{ steps.version.outputs.version }}"

      # ==============================
      # Fetch merged PR body (API)
      # ==============================
      - name: Fetch PR description
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(gh api \
            repos/${{ github.repository }}/commits/${{ github.sha }}/pulls \
            --jq '.[0].body' 2>/dev/null || true)

          if [ -z "$BODY" ]; then
            BODY="（未找到关联的 PR）"
          fi

          BODY="${BODY//$'\n'/%0A}"
          echo "body=$BODY" >> $GITHUB_OUTPUT

      # ==============================
      # Generate commit diff changelog
      # ==============================
      - name: Generate changelog
        id: changelog
        run: |
          if [ -z "${{ steps.prev.outputs.tag }}" ]; then
            LOG="首次发布"
          else
            LOG=$(git log ${{ steps.prev.outputs.tag }}..HEAD --oneline)
          fi

          LOG="${LOG//$'\n'/%0A}"
          echo "log=$LOG" >> $GITHUB_OUTPUT

      # ==============================
      # Prepare clean release directory
      # ==============================
      - name: Prepare release files
        run: |
          mkdir release
          rsync -av \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'doc' \
            --exclude '.gitignore' \
            --exclude 'README.md' \
            --exclude 'requirements.txt' \
            ./ release/

      # ==============================
      # Create zip
      # ==============================
      - name: Create zip
        run: |
          cd release
          zip -r ../cet-${{ steps.version.outputs.version }}.zip .

      # ==============================
      # Create tar.gz
      # ==============================
      - name: Create tar.gz
        run: |
          cd release
          tar -czf ../cet-${{ steps.version.outputs.version }}.tar.gz .

      # ==============================
      # Create GitHub Release
      # ==============================
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Version ${{ steps.version.outputs.version }}
          body: |
            ## 说明

            此发行版对应仓库版本${{ steps.version.outputs.version }}，精简体积，可直接作为库使用，也可以在CLI使用

            ## 如果作为库使用

            请直接将仓库内容放置在项目根目录后导入使用

            ## 更新日志（Clean）

            ${{ steps.pr.outputs.body }}

            ## 更新日志（Commit Diff）

            ${{ steps.changelog.outputs.log }}
          files: |
            cet-${{ steps.version.outputs.version }}.zip
            cet-${{ steps.version.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}