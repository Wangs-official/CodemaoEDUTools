name: Release on Main Push

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      # Checkout main
      # ------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          tags: true

      # ------------------------------
      # Read current version
      # ------------------------------
      - name: Read version from __init__.py
        id: version
        run: |
          VERSION=$(python - << 'EOF'
          import re
          from pathlib import Path

          content = Path("CodemaoEDUTools/__init__.py").read_text(encoding="utf-8")
          match = re.search(r"__version__\s*=\s*['\"]([^'\"]+)['\"]", content)
          if not match:
              raise RuntimeError("Cannot find __version__")
          print(match.group(1))
          EOF
          )
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ------------------------------
      # Get previous tag
      # ------------------------------
      - name: Get previous tag
        id: prev_tag
        run: |
          git fetch --tags
          PREV_TAG=$(git tag --sort=-creatordate | head -n 1)
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      # ------------------------------
      # Ensure version changed
      # ------------------------------
      - name: Ensure version is updated
        run: |
          if [ -z "${{ steps.prev_tag.outputs.prev_tag }}" ]; then
            echo "✅ First release, skip version check"
            exit 0
          fi

          git show ${{ steps.prev_tag.outputs.prev_tag }}:CodemaoEDUTools/__init__.py > /tmp/old_init.py

          OLD_VERSION=$(python - << 'EOF'
          import re
          from pathlib import Path
          content = Path("/tmp/old_init.py").read_text(encoding="utf-8")
          print(re.search(r"__version__\s*=\s*['\"]([^'\"]+)['\"]", content).group(1))
          EOF
          )

          if [ "$OLD_VERSION" = "${{ steps.version.outputs.version }}" ]; then
            echo "❌ __version__ unchanged, abort release"
            exit 1
          fi

          echo "✅ Version changed: $OLD_VERSION → ${{ steps.version.outputs.version }}"

      # ------------------------------
      # Fetch PR body via GitHub API
      # ------------------------------
      - name: Fetch merged PR body
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY=$(gh api \
            repos/${{ github.repository }}/commits/${{ github.sha }}/pulls \
            --jq '.[0].body' 2>/dev/null || true)

          if [ -z "$PR_BODY" ]; then
            PR_BODY="（未找到关联的 PR，可能是直接 push 或 squash 方式不包含 PR body）"
          fi

          PR_BODY="${PR_BODY//$'\n'/%0A}"
          echo "body=$PR_BODY" >> $GITHUB_OUTPUT

      # ------------------------------
      # Generate commit diff changelog
      # ------------------------------
      - name: Generate commit diff changelog
        id: changelog
        run: |
          if [ -z "${{ steps.prev_tag.outputs.prev_tag }}" ]; then
            CHANGELOG="首次发布"
          else
            CHANGELOG=$(git log ${{ steps.prev_tag.outputs.prev_tag }}..HEAD --oneline)
          fi

          CHANGELOG="${CHANGELOG//$'\n'/%0A}"
          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

      # ------------------------------
      # Prepare release directory
      # ------------------------------
      - name: Prepare release directory
        run: |
          mkdir release
          rsync -av \
            --exclude '.git' \
            --exclude 'doc' \
            --exclude '.gitignore' \
            --exclude 'requirements.txt' \
            --exclude 'README.md' \
            ./ release/

      # ------------------------------
      # Package zip
      # ------------------------------
      - name: Create zip package
        run: |
          cd release
          zip -r ../cet-${{ steps.version.outputs.version }}.zip .

      # ------------------------------
      # Package tar.gz
      # ------------------------------
      - name: Create tar.gz package
        run: |
          cd release
          tar -czf ../cet-${{ steps.version.outputs.version }}.tar.gz .

      # ------------------------------
      # Create GitHub Release
      # ------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Version ${{ steps.version.outputs.version }}
          body: |
            ## 说明

            此发行版对应仓库版本${{ steps.version.outputs.version }}，精简体积，可直接作为库使用，也可以在CLI使用

            ## 如果作为库使用

            请直接将`CodemaoEDUTools`文件夹放置在项目的根目录，然后使用代码导入即可

            ## 更新日志（Clean）

            ${{ steps.pr.outputs.body }}

            ## 更新日志（Commit Diff）

            ${{ steps.changelog.outputs.changelog }}
          files: |
            cet-${{ steps.version.outputs.version }}.zip
            cet-${{ steps.version.outputs.version }}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}