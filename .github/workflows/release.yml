name: Release & Publish PyPI

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ======================
      # Checkout
      # ======================
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ======================
      # Get version
      # ======================
      - name: Read version
        id: version
        run: |
          python - << 'EOF'
          import re, pathlib
          text = pathlib.Path("CodemaoEDUTools/__init__.py").read_text()
          m = re.search(r'__version__\s*=\s*"([^"]+)"', text)
          if not m:
              raise SystemExit("âŒ __version__ not found")
          print(f"version={m.group(1)}")
          EOF >> $GITHUB_OUTPUT

      # ======================
      # Check tag not exists
      # ======================
      - name: Check tag
        run: |
          if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "âŒ Tag already exists"
            exit 1
          fi

      # ======================
      # Create & push tag
      # ======================
      - name: Create tag
        run: |
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}

      # ======================
      # Get merged PR description
      # ======================
      - name: Get PR body
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "closed",
              base: "main",
              per_page: 1
            });
            const pr = prs.find(p => p.merge_commit_sha === context.sha);
            return pr ? pr.body || "" : "";

      # ======================
      # Build release package
      # ======================
      - name: Build zip & tar
        run: |
          mkdir release
          rsync -av \
            --exclude .git \
            --exclude .github \
            --exclude doc \
            --exclude .gitignore \
            --exclude README.md \
            --exclude main.py \
            --exclude setup.py \
            CodemaoEDUTools release/CodemaoEDUTools

          cd release
          zip -r ../cet-${{ steps.version.outputs.version }}.zip CodemaoEDUTools
          tar czf ../cet-${{ steps.version.outputs.version }}.tar.gz CodemaoEDUTools

      # ======================
      # Build wheel (optional)
      # ======================
      - name: Build wheel
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip build
          python -m build

      # ======================
      # Create GitHub Release
      # ======================
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Version ${{ steps.version.outputs.version }}
          body: |
            <img src="https://s3.bmp.ovh/imgs/2024/10/25/7cd326afa68c3c6a.png" width="81" alt="è¨€å¶å¤§é­”ç‹">

            ## ğŸ”§ å‘è¡Œç‰ˆè¯´æ˜ï¼š

            æ­¤å‘è¡Œç‰ˆç”± GitHub Action è‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚æœä½ è¦å°† CodemaoEDUTools ä½œä¸ºåº“å¯¼å…¥åˆ°é¡¹ç›®å†…ï¼Œè¯·ä¸‹è½½æ­¤å‘è¡Œç‰ˆ

            ## ğŸ± ä¸åŒä¹‹å¤„ï¼š

            æ­¤å‘è¡Œç‰ˆä»…åŒ…å« **CodemaoEDUTools** åº“æ–‡ä»¶å¤¹ï¼Œå¹¶æä¾›å¯ç›´æ¥å®‰è£…çš„ wheel åŒ…

            ## ğŸ”§ ä½¿ç”¨æ–¹æ³•ï¼š

            - ç›´æ¥æ‹·è´ `CodemaoEDUTools`
            - æˆ–å®‰è£… wheelï¼š`pip install <wheelè·¯å¾„>`

            ## ğŸ’» æ›´æ–°æ—¥å¿—

            ${{ steps.pr.outputs.result }}
          files: |
            cet-${{ steps.version.outputs.version }}.zip
            cet-${{ steps.version.outputs.version }}.tar.gz
            dist/*.whl

      # ======================
      # Publish PyPI
      # ======================
      - name: Publish PyPI
        if: success()
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          if [ -d dist ]; then
            python -m pip install twine
            python -m twine upload dist/*
          else
            echo "âš ï¸ No dist directory, skip PyPI"
          fi