name: Release on main

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      # ==============================
      # Checkout
      # ==============================
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          tags: true

      # ==============================
      # Read version from CodemaoEDUTools/__init__.py
      # ==============================
      - name: Read version
        id: version
        run: |
          INIT_FILE="CodemaoEDUTools/__init__.py"

          if [ ! -f "$INIT_FILE" ]; then
            echo "âŒ $INIT_FILE not found"
            exit 1
          fi

          VERSION=$(python - << 'EOF'
          import re
          from pathlib import Path

          content = Path("CodemaoEDUTools/__init__.py").read_text(encoding="utf-8")
          m = re.search(r"__version__\s*=\s*['\"]([^'\"]+)['\"]", content)
          if not m:
              raise SystemExit("âŒ __version__ not found")
          print(m.group(1))
          EOF
          )

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ==============================
      # Fetch merged PR body via API
      # ==============================
      - name: Fetch PR description
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(gh api \
            repos/${{ github.repository }}/commits/${{ github.sha }}/pulls \
            --jq '.[0].body' 2>/dev/null || true)

          if [ -z "$BODY" ]; then
            BODY="ï¼ˆæœªæ‰¾åˆ°å…³è”çš„ PRï¼‰"
          fi

          BODY="${BODY//$'\n'/%0A}"
          echo "body=$BODY" >> $GITHUB_OUTPUT

      # ==============================
      # Prepare clean release directory
      # ==============================
      - name: Prepare release files
        run: |
          mkdir release
          rsync -av \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'doc' \
            --exclude '.gitignore' \
            --exclude 'README.md' \
            --exclude 'main.py' \
            --exclude 'setup.py' \
            ./ release/

      # ==============================
      # Create zip
      # ==============================
      - name: Create zip
        run: |
          cd release
          zip -r ../cet-${{ steps.version.outputs.version }}.zip .

      # ==============================
      # Create tar.gz
      # ==============================
      - name: Create tar.gz
        run: |
          cd release
          tar -czf ../cet-${{ steps.version.outputs.version }}.tar.gz .

      # ==============================
      # Build wheel (optional)
      # ==============================
      - name: Build wheel
        id: wheel
        continue-on-error: true
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python setup.py bdist_wheel
          WHEEL_FILE=$(ls dist/*.whl 2>/dev/null | head -n 1 || true)

          if [ -n "$WHEEL_FILE" ]; then
            echo "wheel=$WHEEL_FILE" >> $GITHUB_OUTPUT
          fi

      # ==============================
      # Create GitHub Release
      # ==============================
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Version ${{ steps.version.outputs.version }}
          body: |
            <img src="https://s3.bmp.ovh/imgs/2024/10/25/7cd326afa68c3c6a.png" width="81" alt="è¨€å¶å¤§é­”ç‹">

            ## ğŸ”§ å‘è¡Œç‰ˆè¯´æ˜ï¼š

            æ­¤å‘è¡Œç‰ˆç”±GitHub Actionç”Ÿæˆï¼Œå¦‚æœä½ è¦å°†CodemaoEDUToolsä½œä¸ºåº“å¯¼å…¥åˆ°é¡¹ç›®å†…ï¼Œè¯·ä¸‹è½½æ­¤å‘è¡Œç‰ˆ

            ## ğŸ± ä¸åŒä¹‹å¤„ï¼š

            æ­¤å‘è¡Œç‰ˆä»…åŒ…å«äº† **CodemaoEDUTools** åº“æ–‡ä»¶å¤¹ï¼ŒåŒæ—¶ä¹Ÿæä¾›äº†å¯ä»¥ç›´æ¥å®‰è£…çš„ wheel åŒ…

            ## ğŸ”§ ä½¿ç”¨æ–¹æ³•ï¼š

            å°†æ•´ä¸ª **CodemaoEDUTools** åº“æ–‡ä»¶å¤¹æ”¾å…¥åˆ°ä½ çš„é¡¹ç›®å†…ï¼Œæˆ–è€…ä¸‹è½½ wheel åŒ…è¿›è¡Œæœ¬åœ°å®‰è£…

            å¯¼å…¥ï¼š`import CodemaoEDUTools`  
            å®‰è£…ï¼š`pip install <wheelåŒ…è·¯å¾„>` or `pip install`

            ## ğŸ’» æ›´æ–°æ—¥å¿—

            ${{ steps.pr.outputs.body }}
          files: |
            cet-${{ steps.version.outputs.version }}.zip
            cet-${{ steps.version.outputs.version }}.tar.gz
            ${{ steps.wheel.outputs.wheel }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}